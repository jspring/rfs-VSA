#!/bin/bash

ps -ef | grep -v grep | grep opt_vsa
if [[ $? -ne 0 ]]
then
	sudo killall opt_vsa
fi

ps -ef | grep -v grep | grep xml_parser
if [[ $? -ne 0 ]]
then
	sudo killall xml_parser
fi

ps -ef | grep -v grep | grep clt_vars
if [[ $? -ne 0 ]]
then
	sudo killall clt_vars
fi

ps -ef | grep -v grep | grep db_slv
if [[ $? -ne 0 ]]
then
	sudo killall db_slv
fi

sudo /home/path/db/db_clean.sh

ps -elf | grep -v grep | grep db_slv
if [[ $? != 0 ]]
then
	/home/path/db/lnx/db_slv &
fi

ps -elf | grep -v grep | grep clt_vars
if [[ $? != 0 ]]
then
	/home/rfs-VSA/src/lnx/clt_vars &
fi

ps -elf | grep -v grep | grep opt_vsa
if [[ $? != 0 ]]
then
	cd /home/rfs-VSA/src
	./lnx/opt_vsa &
 fi

while [[ 1 ]]
do
	COUNTER=0
	TIMESINCELASTDATA=0
	while [[ ($TIMESINCELASTDATA -lt 5) && ($COUNTER -le 6) ]]
	do
		NOWTIME=`date +%s`
		date >>/var/log/vsa/run_vsa.err
		LATESTFILE=`ls -t /var/www/html/VSA/data/datafeed* | head -1` 2>>/var/log/vsa/run_vsa.err
		LATESTFILETIME=`stat -c %X $LATESTFILE` 2>>/var/log/vsa/run_vsa.err
		TIMESINCELASTDATA=`echo $(($NOWTIME-$LATESTFILETIME))`
		if [[ $TIMESINCELASTDATA -lt 5 ]]
		then
			COUNTER=$(($COUNTER+1))
			sleep 5
		fi
	done
	
	if [[ $TIMESINCELASTDATA -gt 7200 ]]
	then
		echo Latest data is $TIMESINCELASTDATA seconds old. That is longer than 7200 seconds, so we are exiting.... >>/var/log/vsa/run_vsa.err
		cd /var/www/html/VSA/webdata
		for x in `ls [123]*`
		do
			echo "Stale data" >$x
		done
		exit 0
	fi
	
	/home/rfs-VSA/src/lnx/xml_parser -f $LATESTFILE 2>>/var/log/vsa/run_vsa.err
	sleep 30
done
